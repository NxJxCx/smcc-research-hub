import{MainContext as e}from"/jsx/context";import t from"/jsx/global/clsx";import a from"/jsx/global/modal";import o from"/jsx/global/pdfviewer";import{React as r,Sweetalert2 as l}from"/jsx/imports";import n from"/jsx/main/search";function s({id:t,title:a,month:o,year:n,volume:s,number:i,publishedDate:c,thumbnail:m,onRefresh:u,onSelect:d}){const{authenticated:h,authData:f}=r.useContext(e);r.useCallback((e=>{e.preventDefault(),e.stopPropagation();const a=new URL("/api/journal/markfavorite",window.location.origin),o=JSON.stringify({id:t,[f?.account]:f?.id});fetch(a,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8",Accept:"application/json; charset=UTF-8"},body:o}).then((e=>e.json())).then((({success:e,error:t})=>{t?l.fire({icon:"error",title:"Error",text:"Failed to mark journal as favorite: "+t,toast:!0,showConfirmButton:!1,position:"center",timer:3e3}):e?u&&u():l.fire({icon:"error",title:"Error",text:"Failed to mark journal as favorite",toast:!0,showConfirmButton:!1,position:"center",timer:3e3})})).catch(console.log)}),[t,f]);return r.createElement(r.Fragment,null,r.createElement("div",{onClick:()=>d&&d(t),className:"text-center relative cursor-pointer border rounded-lg p-4 w-[70mm] hover:bg-gray-200"},r.createElement("div",{className:"flex flex-col"},r.createElement("div",{className:"min-w-[60mm] max-w-[60mm] min-h-[70mm] max-h-[70mm] rounded border shadow"},r.createElement("img",{src:m,alt:"Thumbnail",className:"object-contain h-full"})),r.createElement("div",{className:"px-4 mt-4"},r.createElement("div",{className:"pt-2 px-4 font-bold leading-tight"},a,", ",o),r.createElement("div",{className:"pb-2 px-2 italic leading-tight"},"Vol. ",s," No. ",i," (",n,")"),r.createElement("div",{className:"pb-2 px-2 leading-tight text-gray-700 italic text-center text-sm"},"Published Date: ",new Date(c).toLocaleDateString())))))}function i({journal:t,theses:a=[],search:o,onViewPdf:n,onBack:s,onRefresh:i}){const{authenticated:c,authData:m}=r.useContext(e),u=r.useMemo((()=>a?.filter((e=>!o||e.title?.toString()?.toLowerCase()?.includes(o.toLowerCase())||e.abstract?.toString()?.toLowerCase()?.includes(o.toLowerCase())||e.author?.toString().toLowerCase()?.includes(o.toLowerCase())||e.year?.toString()?.toLowerCase()?.includes(o.toLowerCase())))||[]),[a,o]);console.log(u);const d=r.useCallback(((e,t)=>{e.preventDefault(),e.stopPropagation();const a=new URL("/api/thesis/markfavorite",window.location.origin),o=JSON.stringify({id:t,[m?.account]:m?.id});fetch(a,{method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8",Accept:"application/json; charset=UTF-8"},body:o}).then((e=>e.json())).then((({success:e,error:t})=>{t?l.fire({icon:"error",title:"Error",text:"Failed to mark thesis as favorite: "+t,toast:!0,showConfirmButton:!1,position:"center",timer:3e3}):e?i&&i():l.fire({icon:"error",title:"Error",text:"Failed to mark thesis as favorite",toast:!0,showConfirmButton:!1,position:"center",timer:3e3})})).catch(console.log)}),[m]);return r.createElement("div",{className:"w-full font-[Roboto] relative"},r.createElement("button",{type:"button",onClick:s,className:"flex items-center justify-start"},r.createElement("span",{className:"material-symbols-outlined"},"chevron_left"),r.createElement("span",{className:"underline"},"Back")),r.createElement("div",{className:"flex flex-col gap-y-4 lg:gap-y-0 lg:flex-row py-16"},r.createElement("div",{className:"lg:w-1/2"},r.createElement("div",{className:"min-w-[60mm] max-w-[60mm] min-h-[70mm] max-h-[70mm] rounded border shadow mx-auto"},r.createElement("img",{src:t?.thumbnail,alt:"Thumbnail",className:"object-contain h-full"}))),r.createElement("div",{className:"text-center min-w-[60mm]"},r.createElement("h2",{className:"font-bold text-lg"},t?.title,", ",t?.month),r.createElement("div",{className:"font-[400] text-sm text-gray-600"},"Vol. ",t?.volume," No. ",t?.number," (",t?.year,")"),r.createElement("div",{className:"font-bold text-sm text-gray-600 mt-3"},"Published Date"),r.createElement("div",{className:"text-sm text-gray-600"},new Date(t?.published_date).toLocaleDateString()),r.createElement("div",{className:"text-sm text-gray-600 mt-3"},a.length," Theses"))),r.createElement("div",{className:"min-h-[400px] px-2"},r.createElement("div",{className:"border-t"},r.createElement("div",{className:"-translate-y-[55%] ml-4 bg-white w-fit"},"Thesis")),r.createElement("div",{className:"mt-2 max-h-[380px] h-full overflow-y-auto w-full px-8"},0===u.length?r.createElement("span",{className:"py-8"},"No Theses found in ",o?"your search":"this journal","."):r.createElement("div",{className:"flex flex-wrap leading-tight gap-4"},u.map((e=>r.createElement("div",{key:e?.id,onClick:()=>n(e),className:"relative hover:bg-gray-200 hover:shadow w-1/2 p-2 cursor-pointer rounded"},c&&"admin"!==m?.account&&r.createElement("button",{type:"button",onClick:t=>d(t,e?.id),className:"absolute right-2 top-3 z-20 hover:text-yellow-500"},e?.favorite&&r.createElement("span",{className:"material-symbols-outlined text-green-700"},"bookmark_star"),!e?.favorite&&r.createElement("span",{className:"material-symbols-outlined"},"bookmark")),r.createElement("div",{className:"font-bold"},e?.title),r.createElement("div",{className:"text-sm font-[400] text-gray-600"},e?.author," (",e?.year,")"),r.createElement("div",{className:"leading-tight"},r.createElement("div",{className:"material-symbols-outlined aspect-square text-sm mr-1 font-bold"},"visibility"),r.createElement("div",{className:"inline pb-1 font-[500]"},e?.totalViews)))))))))}export default function c(){const{authenticated:l,authData:c}=r.useContext(e),[m,u]=r.useState(new URLSearchParams(new URL(window.location.href).search).get("search")||""),d=r.useMemo((()=>new URLSearchParams(new URL(window.location.href).search)),[]),h=r.useCallback((e=>{u(e),d.set("search",e),window.history.pushState({},"",`?${d.toString()}`)}),[]),[f,p]=r.useState([]),[x,w]=r.useState(null),g=r.useMemo((()=>f.reduce(((e,t)=>e.includes(t.year)?e:[...e,t.year].toSorted(((e,t)=>t-e))),[])),[f]),[b,v]=r.useState((new Date).getFullYear()),E=r.useMemo((()=>x?[]:f.filter((e=>e.year.toString()===b.toString()&&(!m||e.title?.toString()?.toLowerCase()?.includes(m.toLowerCase())||e.volume?.toString()?.toLowerCase()?.includes(m.toLowerCase())||e.number?.toString()?.toLowerCase()?.includes(m.toLowerCase())||e.month?.toLowerCase()?.includes(m.toLowerCase())||e.year?.toString()?.toLowerCase()?.includes(m.toLowerCase())||`${e.title?.toString()?.toLowerCase()}, ${e.month?.toString()?.toLowerCase()}`.includes(m.toLowerCase()))))),[f,b,m,x]),[y,N]=r.useState(1),C=r.useMemo((()=>Math.ceil(E.length/20)),[E]),k=r.useMemo((()=>0===E.length?void 0:E?.slice(20*(y-1),20*y)),[y,E,C]),S=r.useCallback((()=>N((e=>Math.min(C,Math.max(0===C?0:1,e+1))))),[C]),L=r.useCallback((()=>N((e=>Math.min(C,Math.max(0===C?0:1,e-1))))),[C]),j=async()=>{const e=new URL("/api/journal/public/all",window.location.origin);e.searchParams.set(c?.account,c?.id);try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const{success:a,error:o}=await t.json();if(o)throw new Error(`HTTP error: ${o.message}`);if(a)return a.sort(((e,t)=>new Date(e.created_at).getTime()>new Date(t.created_at).getTime()?-1:new Date(e.created_at).getTime()==new Date(t.created_at).getTime()?0:1)),p(a),a}catch(e){console.log(e)}return[]};r.useEffect((()=>{j().catch()}),[]);const[T,D]=r.useState(),[P,R]=r.useState(),[U,F]=r.useState(),M=r.useCallback((e=>{const t=e?.title,a=e?.author,o=new URL(`read${e?.url}`,window.location.origin).toString();R(t),F(a),D(o)}),[]),B=r.useCallback((e=>{u(""),w(f.find((t=>t.id==e)))}),[f]),_=r.useCallback((async()=>{if(x){const e=x.id,t=await j(),a=t?.find((t=>t.id===e));w(a)}}),[x]);return r.createElement(r.Fragment,null,r.createElement("div",{className:"flex py-4 px-8 mt-4"},r.createElement("div",{className:"flex-grow mt-3"},r.createElement("h1",{className:"text-2xl font-bold text-center"},"Journals"),!x&&r.createElement("div",{className:"flex flex-wrap p-4 gap-4"},!!b&&(k?.map((e=>r.createElement(s,{key:e.id,id:e.id,title:e.title,volume:e.volume,number:e.number,month:e.month,thumbnail:e.thumbnail,year:e.year,publishedDate:e.published_date,onRefresh:j,onSelect:B})))||r.createElement("div",{className:"lg:col-span-2 xl:col-span-3 mx-auto"},r.createElement("div",{className:"h-[200px] mb-2"},r.createElement("div",{className:"border-2 border-gray-300 rounded-lg p-4"},r.createElement("div",{className:"text-gray-500"},"No journal found.")))))),!!x&&!!b&&r.createElement(i,{journal:x,theses:x.theses,onViewPdf:M,search:m,onBack:()=>w(null),onRefresh:_})),r.createElement("div",{className:"min-w-[326px] max-w-[326px] h-[600px] flex flex-col"},r.createElement("div",{className:"min-h-[400px] flex-grow"},r.createElement("div",{className:"font-bold text-xl mb-4 w-full"},"Year"),g.map(((e,a)=>r.createElement("button",{key:a,type:"button",className:t("flex items-center px-4 py-2 text-left",b.toString()===e.toString()?"bg-gray-200 font-bold":"hover:bg-gray-300"),onClick:()=>v(Number.parseInt(e))},e)))),r.createElement("div",{className:"flex-shrink text-slate-700 font-[600] w-full mb-3"},r.createElement(n,{search:m,onSearch:h})),r.createElement("div",{className:"text-slate-700 font-[600] max-w-full overflow-x-auto overflow-y-hidden"},r.createElement("div",{className:"flex"},Array.from({length:C}).map(((e,a)=>r.createElement("button",{key:a,type:"button",className:t("flex items-center px-4 py-2 text-left",y===a+1?"bg-gray-200 font-bold":"hover:bg-gray-300"),onClick:()=>N(a+1)},a+1))))),x?r.createElement("div",{className:"flex-shrink text-slate-700 font-[600] mx-auto"},r.createElement("div",{className:"p-4"},"Â ")):r.createElement("div",{className:"flex-shrink text-slate-700 font-[600] mx-auto"},r.createElement("button",{type:"button",className:"p-1 hover:text-yellow-700",onClick:()=>N(0===C?0:1)},"<<"),r.createElement("button",{type:"button",className:"p-1 hover:text-yellow-700",onClick:L},"<"," Prev"),r.createElement("button",{type:"button",className:"p-1 hover:text-yellow-700",onClick:S},"Next ",">"),r.createElement("button",{type:"button",className:"p-1 hover:text-yellow-700",onClick:()=>N(C)},">>")))),r.createElement(a,{open:!!x&&!!T,onClose:()=>{D(void 0),R(void 0),F(void 0)},content:l?r.createElement(o,{src:T}):r.createElement("div",{className:"w-full text-center min-h-[150px] pt-16"},"Please ",r.createElement("a",{href:"/login",className:"text-sky-700 underline"},"login")," to view journal/thesis."),header:P,showCancelButton:!1,showConfirmButton:!1,footer:U}))}