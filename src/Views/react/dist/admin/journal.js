import e from"/jsx/admin/addjournal";import{CellAlign as t,Table as o,TableCellType as n,TableRowAction as l}from"/jsx/admin/table";import a from"/jsx/global/modal";import r from"/jsx/global/pdfviewer";import{React as i,Sweetalert2 as s}from"/jsx/imports";const c=[{label:"#",key:"id",sortable:!0,filterable:!0,cellType:n.Number,align:t.Center},{label:"Thumbnail",key:"thumbnail",sortable:!1,cellType:n.Custom,align:t.Center},{label:"Date Created",key:"created_at",sortable:!0,cellType:n.Date,align:t.Center},{label:"Title",key:"title",sortable:!0,cellType:n.String,align:t.Center},{label:"Author",key:"author",sortable:!0,cellType:n.String,align:t.Center},{label:"Year",key:"year",sortable:!0,cellType:n.Number,align:t.Center},{label:"Publisher",key:"publisher",sortable:!0,cellType:n.String,align:t.Center},{label:"Published Date",key:"published_date",sortable:!0,cellType:n.Date,align:t.Center},{label:"Volume",key:"volume",sortable:!0,cellType:n.Number,align:t.Center},{label:"No.",key:"number",sortable:!0,cellType:n.Number,align:t.Center},{label:"Reads",key:"reads",sortable:!0,cellType:n.Number,align:t.Center},{label:"Status",key:"is_public",sortable:!0,cellType:n.Custom,align:t.Center},{label:"Action",key:"action",sortable:!1,cellType:n.Custom,align:t.Center}];export default function u(){const[t,n]=i.useState(!1),[u,d]=i.useState(""),[m,p]=i.useState(""),[h,b]=i.useState(""),[f,y]=i.useState([]),[w,g]=i.useState(""),C=i.useCallback((e=>{s.fire({title:"Edit Thumbnail",text:"Enter the new thumbnail URL:",input:"file",inputValue:e.thumbnail,showCancelButton:!0,confirmButtonText:"Save",cancelButtonText:"Cancel",showLoaderOnConfirm:!0,preConfirm:t=>new Promise(((o,n)=>{if(t&&t.size>3145728)n("Thumbnail File size exceeds the maximum limit of 3MB.");else{const l=new URLSearchParams(new URL(e.thumbnail,window.location.origin).search),a=new FormData;a.append("id",e.id),a.append("filename",l.get("filename")||""),console.log(t.type),a.append("thumbnail",new Blob([t],{type:t.type}),t.name);const r=new URL("/api/thumbnail/edit",window.location.origin),i=new XMLHttpRequest;i.open("POST",r,!0),i.onload=()=>{if(201===i.status){const e=JSON.parse(i.responseText);e.error?n(e.error):o("Journal Document uploaded successfully.")}else n(JSON.parse(i.responseText)?.error||"Failed to upload")},i.onerror=e=>{n(JSON.parse(i.responseText)?.error||"Error Uploading")},i.send(a)}})).then((e=>e)).catch((e=>{s.showValidationMessage(e.message)}))}).then((({isConfirmed:e,value:t})=>{e&&(s.fire({icon:"success",title:"Thumbnail Updated",text:t,toast:!0,showConfirmButton:!1,position:"center",timer:2e3}),setTimeout((()=>x()),500))}))}),[]),x=()=>{fetch("/api/journal/all").then((e=>e.json())).then((({success:e,error:t})=>{t?console.log(t):y(e.map((e=>({id:e.id,created_at:e.created_at,title:e.title,author:e.author,year:e.year,volume:e.volume,number:e.number,publisher:e.publisher,published_date:e.published_date,thumbnail:{value:e.thumbnail,content:i.createElement(i.Fragment,null,i.createElement("button",{type:"button",onClick:()=>C(e),className:"relative w-[70px] h-[90px] after:absolute after:left-0 after:top-0 after:w-[70px] after:h-[90px] hover:after:bg-white/40 hover:after:content-center hover:after:content-['edit'] hover:after:drop-shadow-lg hover:after:text-black"},i.createElement("img",{src:new URL(e.thumbnail,window?.location?.origin).toString(),alt:"thumbnail",className:"w-full h-full object-contain"})))},reads:e.reads||0,is_public:{value:e.is_public?"Yes":"No",content:e.is_public?i.createElement("button",{type:"button",className:"bg-white px-3 py-2 text-green-700 font-bold rounded-2xl leading-[14.63px] text-[12px]",onClick:()=>{s.fire({icon:"question",title:"Do you want to hide this journal to the public?",confirmButtonText:"Yes, Hide Journal",confirmButtonColor:"#3085d6",showDenyButton:!0,denyButtonText:"No, Cancel",denyButtonColor:"#d33",showLoaderOnConfirm:!0,preConfirm:async()=>{try{const t=new URL("/api/journal/publish",window.location.origin),o=await fetch(t,{method:"POST",body:JSON.stringify({id:e.id,is_public:!1}),headers:{"Content-Type":"application/json",Accept:"application/json"}});if(!o.ok){const{error:e}=await o.json();return s.showValidationMessage("Failed: "+e)}return o.json()}catch(e){s.showValidationMessage("Failed: "+e)}},allowOutsideClick:()=>!s.isLoading()}).then((e=>{e.isConfirmed&&(e.value?.error?s.fire({icon:"error",title:"Error",text:"Failed to make journal hidden: "+e.value.error,timer:3e3,toast:!0,position:"center"}):(s.fire({icon:"success",title:"Journal Hidden Successfully",timer:3e3,toast:!0,position:"center"}),x()))}))}},"Public"):i.createElement("button",{type:"button",className:"bg-white px-3 py-2 text-red-500 rounded-2xl font-[500] leading-[14.63px] text-[12px]",onClick:()=>{s.fire({icon:"question",title:"Do you want to display this journal publicly?",confirmButtonText:"Yes, Display Journal publicly",confirmButtonColor:"#3085d6",showDenyButton:!0,denyButtonText:"No, Cancel",denyButtonColor:"#d33",showLoaderOnConfirm:!0,preConfirm:async()=>{try{const t=new URL("/api/journal/publish",window.location.origin),o=await fetch(t,{method:"POST",body:JSON.stringify({id:e.id,is_public:!0}),headers:{"Content-Type":"application/json",Accept:"application/json"}});if(!o.ok){const{error:e}=await o.json();return s.showValidationMessage("Failed: "+e)}return o.json()}catch(e){s.showValidationMessage("Failed: "+e)}},allowOutsideClick:()=>!s.isLoading()}).then((e=>{e.isConfirmed&&(e.value?.error?s.fire({icon:"error",title:"Error",text:"Failed to make journal public: "+e.value.error,timer:3e3,toast:!0,position:"center"}):(s.fire({icon:"success",title:"Journal Publicly Displayed Successfully",timer:3e3,toast:!0,position:"center"}),x()))}))}},"Hidden")},action:i.createElement(l,{id:e.id,onView:t=>{t===e.id&&(p(e.title),b("Author/s: "+e.author+" ("+e.year+")"),d(new URL(`/read${e.url}`,window.location.origin).toString()))},onDelete:e=>{s.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Yes, delete journal!"}).then((({isConfirmed:t})=>{t&&fetch(`/api/journal/delete?id=${e}`,{method:"DELETE"}).then((e=>e.json())).then((({success:e,error:t})=>{e?(x(),s.fire({icon:"success",title:"Deleted!",text:"Journal has been deleted successfully.",timer:3e3})):(console.log(t),s.fire({icon:"error",title:"Error",text:"Failed to delete thesis: "+t,confirmButtonText:"Try Again"}))})).catch((e=>{console.log(e),s.fire({icon:"error",title:"Error",text:"Failed to delete journal",timer:3e3})}))}))}})}))))})).catch((e=>{console.log(e),s.fire({icon:"error",title:"Error",text:"Failed to fetch journal list",confirmButtonText:"Try Again",showCancelButton:!0}).then((({isConfirmed:e})=>{e&&setTimeout((()=>x()),50)}))}))};return i.useEffect((()=>{u||(p(""),b(""))}),[u]),i.useEffect((()=>{x()}),[]),i.createElement("div",{className:"w-full min-h-[calc(100vh-160px)] h-fit bg-[#37414e] p-4 min-w-fit"},i.createElement("h1",{className:"text-white text-2xl my-2"},"Journal List"),i.createElement(o,{columns:c,items:f},i.createElement("div",{className:"px-4"},i.createElement("button",{type:"button",onClick:()=>x(),className:"hover:text-yellow-500",title:"Refresh List"},i.createElement("span",{className:"material-symbols-outlined"},"refresh"))),i.createElement("div",{className:"px-4"},i.createElement("button",{type:"button",onClick:()=>n(!0),className:"hover:text-yellow-500",title:"Add Journal"},i.createElement("span",{className:"material-symbols-outlined"},"add"))),i.createElement(e,{open:t,onClose:()=>n(!1),onSuccess:()=>x(),className:"absolute right-3 top-full mt-4 shadow-lg"})),i.createElement(a,{open:!!u,onClose:()=>d(null),content:i.createElement(r,{src:u}),header:m,showCancelButton:!1,showConfirmButton:!1,footer:h}))}